<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGN to Pages - Live Tournament Website Generator</title>
    <style>
        /* Main Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #4a90e2, #81b6f5);
            color: white;
            text-align: center;
            padding: 60px 20px;
            margin-bottom: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMjUgMjVMNTAgNTBMMjUgNzVMNTAgMTAwTDc1IDc1TDUwIDUwTDc1IDI1TDUwIDBMMjUgMjVaIiBmaWxsPSJyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMDUpIiAvPjwvc3ZnPg==');
            background-size: 100px 100px;
            opacity: 0.1;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }
        
        .header h1::before,
        .header h1::after {
            content: '‚ôî';
            font-size: 2rem;
            margin: 0 15px;
            color: #d4af37;
            vertical-align: middle;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .upload-area {
            border: 3px dashed #4a90e2;
            border-radius: 15px;
            padding: 60px;
            text-align: center;
            background: #f9fbfd;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background: #e3f2fd;
            border-color: #2c3e50;
        }
        
        .upload-area.dragging {
            background: #e3f2fd;
            border-color: #2c3e50;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #4a90e2;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-button {
            background: linear-gradient(135deg, #4a90e2, #81b6f5);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        /* Processing Section */
        .processing-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        .processing-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .processing-spinner {
            font-size: 2rem;
            color: #4a90e2;
            animation: spin 1s linear infinite;
            margin-right: 20px;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .processing-title {
            font-size: 1.5rem;
            color: #2c3e50;
        }
        
        .progress-bar {
            background: #f0f0f0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #4a90e2, #81b6f5);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .processing-log {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .log-entry::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #4a90e2;
        }
        
        .log-entry.error::before {
            content: '‚úó';
            color: #e74c3c;
        }
        
        /* Results Section */
        .results-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        .results-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .results-header h2 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .success-icon {
            font-size: 4rem;
            color: #27ae60;
            margin-bottom: 20px;
        }
        
        .tournament-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .tournament-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #4a90e2;
            transition: all 0.3s ease;
        }
        
        .tournament-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .tournament-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .tournament-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .tournament-type {
            display: inline-block;
            background: #4a90e2;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-top: 10px;
        }
        
        .download-container {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
        }
        
        .download-button {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .download-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .download-info {
            color: #666;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .preview-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .preview-button {
            background: linear-gradient(135deg, #4a90e2, #81b6f5);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preview-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Error Section */
        .error-section {
            background: #ffebee;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
            text-align: center;
        }
        
        .error-icon {
            font-size: 4rem;
            color: #e74c3c;
            margin-bottom: 20px;
        }
        
        .error-message {
            color: #c0392b;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .error-details {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .reset-button {
            background: #e74c3c;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .reset-button:hover {
            background: #c0392b;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .tournament-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>PGN to Pages</h1>
                <p>Transform your PGN files into beautiful tournament websites</p>
            </div>
        </div>
        
        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Upload Your PGN File</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    Drag and drop your PGN file here or click to browse
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".pgn" multiple>
                <button class="upload-button">Choose PGN File</button>
            </div>
        </div>
        
        <!-- Processing Section -->
        <div class="processing-section" id="processingSection">
            <div class="processing-header">
                <div class="processing-spinner">
                    <i class="fas fa-spinner"></i>
                </div>
                <div class="processing-title">Processing PGN File...</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="processing-log" id="processingLog"></div>
        </div>
        
        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2>Website Generated & Published!</h2>
                <p style="color: #666;">Your tournament pages have been automatically saved to the server</p>
            </div>
            
            <h3 style="color: #2c3e50; margin-bottom: 20px;">Tournaments Found:</h3>
            <div class="tournament-grid" id="tournamentGrid"></div>
            
            <div class="download-container">
                <button class="download-button" id="downloadAllBtn">
                    <i class="fas fa-sync"></i> Re-publish Website
                </button>
                <div class="preview-buttons">
                    <button class="preview-button" id="previewHomeBtn">
                        <i class="fas fa-home"></i> Preview Home Page
                    </button>
                    <button class="preview-button" id="resetBtn">
                        <i class="fas fa-redo"></i> Process Another File
                    </button>
                </div>
                <div class="download-info">
                    Pages are automatically published. Click "Re-publish" to update them.
                </div>
            </div>
        </div>
        
        <!-- Error Section -->
        <div class="error-section" id="errorSection">
            <div class="error-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="error-message" id="errorMessage">
                An error occurred while processing your PGN file
            </div>
            <div class="error-details" id="errorDetails"></div>
            <button class="reset-button" onclick="resetProcessor()">
                <i class="fas fa-redo"></i> Try Again
            </button>
        </div>
    </div>
    
    <script>
        // Global variables
        let pgnContent = '';
        let tournaments = [];
        let generatedPages = {};
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadButton = uploadArea.querySelector('.upload-button');
            
            // Click to upload
            uploadArea.addEventListener('click', function(e) {
                if (e.target !== fileInput) {
                    fileInput.click();
                }
            });
            
            uploadButton.addEventListener('click', function(e) {
                e.stopPropagation();
                fileInput.click();
            });
            
            // File input change
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                const pgnFiles = files.filter(f => f.name.endsWith('.pgn'));
                if (pgnFiles.length > 0) {
                    processMultiplePGNFiles(pgnFiles);
                }
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragging');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragging');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragging');
                
                const files = Array.from(e.dataTransfer.files);
                const pgnFiles = files.filter(f => f.name.endsWith('.pgn'));
                if (pgnFiles.length > 0) {
                    processMultiplePGNFiles(pgnFiles);
                }
            });
            
            // Button listeners
            document.getElementById('downloadAllBtn').addEventListener('click', downloadAllPages);
            document.getElementById('previewHomeBtn').addEventListener('click', previewHomePage);
            document.getElementById('resetBtn').addEventListener('click', resetProcessor);
        }
        
        // Show processing section
        function showProcessingSection() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
        }
        
        // Process multiple PGN files
        async function processMultiplePGNFiles(files) {
            try {
                showProcessingSection();
                updateProgress(0, `Processing ${files.length} PGN file(s)...`);
                clearLog();
                
                let allContent = '';
                let fileCount = 0;
                
                for (const file of files) {
                    const content = await readFile(file);
                    // Add a separator comment between files to help identify them
                    if (fileCount > 0) {
                        allContent += `\n\n[Event "--- File: ${file.name} ---"]\n\n`;
                    }
                    allContent += content + '\n\n';
                    fileCount++;
                    updateProgress((fileCount / files.length) * 30, `Read ${fileCount}/${files.length} files...`);
                }
                
                pgnContent = allContent;
                
                // Parse tournaments using existing parsePGN function
                updateProgress(40, 'Parsing tournaments...');
                parsePGN();
                addLogEntry(`Found ${tournaments.length} tournament(s) across ${files.length} file(s)`);
                
                // Generate pages using existing generatePages function
                updateProgress(60, 'Generating tournament pages...');
                generatePages();
                addLogEntry(`Generated ${Object.keys(generatedPages).length} pages`);
                
                // Auto-save to server
                updateProgress(80, 'Saving to server...');
                await autoSavePages();
                
                updateProgress(100, 'Complete!');
                setTimeout(() => {
                    showResults();
                }, 500);
            } catch (error) {
                console.error('Error processing PGN files:', error);
                showError('Failed to process PGN files: ' + error.message, error.stack);
            }
        }
        
        // Helper function to read file
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        // Process PGN file (legacy single file support)
        function processPGNFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                pgnContent = e.target.result;
                startProcessing();
            };
            
            reader.onerror = function() {
                showError('Failed to read the PGN file');
            };
            
            reader.readAsText(file);
        }
        
        // Start processing
        function startProcessing() {
            // Show processing section
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processingSection').style.display = 'block';
            
            // Reset progress
            updateProgress(0);
            clearLog();
            
            // Process in chunks for better UI feedback
            setTimeout(() => {
                try {
                    addLogEntry('Parsing PGN file...');
                    updateProgress(10);
                    
                    parsePGN();
                    
                    addLogEntry(`Found ${tournaments.length} tournament(s)`);
                    updateProgress(30);
                    
                    generatePages();
                    
                    showResults();
                } catch (error) {
                    showError('Failed to process PGN file: ' + error.message, error.stack);
                }
            }, 100);
        }
        
        // Parse PGN content
        function parsePGN() {
            // Split by games
            const games = pgnContent.split(/\n\s*\n/).filter(game => game.trim());
            
            // Extract tournaments
            const tournamentMap = {};
            
            games.forEach(game => {
                // Extract headers
                const headers = {};
                const headerRegex = /\[\s*(\w+)\s*"([^"]*)"\s*\]/g;
                let match;
                
                while ((match = headerRegex.exec(game)) !== null) {
                    headers[match[1]] = match[2];
                }
                
                // Get tournament name
                const tournamentName = headers.Event || 'Unknown Tournament';
                
                // Skip file separator markers
                if (tournamentName.startsWith('--- File:')) {
                    return;
                }
                
                // Determine if it's a team tournament
                const isTeam = headers.WhiteTeam || headers.BlackTeam || 
                              tournamentName.toLowerCase().includes('team') ||
                              tournamentName.toLowerCase().includes('club');
                
                // Create unique key using event name, date, and site to distinguish tournaments
                const tournamentKey = `${tournamentName}_${headers.Date || ''}_${headers.Site || ''}`;
                
                // Initialize tournament
                if (!tournamentMap[tournamentKey]) {
                    tournamentMap[tournamentKey] = {
                        name: tournamentName,
                        date: headers.Date || headers.EventDate || '',
                        site: headers.Site || headers.EventCity || '',
                        type: isTeam ? 'team' : 'individual',
                        games: [],
                        players: new Set(),
                        teams: new Set(),
                        playerDetails: {},
                        teamDetails: {},
                        rounds: new Set()
                    };
                }
                
                const tournament = tournamentMap[tournamentKey];
                
                // Add game data
                if (headers.White && headers.Black) {
                    const gameData = {
                        white: headers.White,
                        black: headers.Black,
                        result: headers.Result || '*',
                        round: headers.Round || '',
                        date: headers.Date || '',
                        whiteTeam: headers.WhiteTeam || '',
                        blackTeam: headers.BlackTeam || '',
                        whiteElo: headers.WhiteElo || '',
                        blackElo: headers.BlackElo || '',
                        eco: headers.ECO || '',
                        opening: headers.Opening || ''
                    };
                    
                    tournament.games.push(gameData);
                    
                    // Track players and teams
                    tournament.players.add(headers.White);
                    tournament.players.add(headers.Black);
                    
                    if (headers.WhiteTeam) tournament.teams.add(headers.WhiteTeam);
                    if (headers.BlackTeam) tournament.teams.add(headers.BlackTeam);
                    
                    if (headers.Round) tournament.rounds.add(headers.Round);
                    
                    // Store player details
                    if (!tournament.playerDetails[headers.White]) {
                        tournament.playerDetails[headers.White] = {
                            name: headers.White,
                            elo: headers.WhiteElo || '',
                            team: headers.WhiteTeam || '',
                            title: headers.WhiteTitle || ''
                        };
                    }
                    
                    if (!tournament.playerDetails[headers.Black]) {
                        tournament.playerDetails[headers.Black] = {
                            name: headers.Black,
                            elo: headers.BlackElo || '',
                            team: headers.BlackTeam || '',
                            title: headers.BlackTitle || ''
                        };
                    }
                }
            });
            
            tournaments = Object.values(tournamentMap);
        }
        
        // Generate all pages
        function generatePages() {
            addLogEntry('Processing tournaments...');
            updateProgress(40);
            
            let progress = 50;
            const progressStep = 30 / tournaments.length;
            
            // First, assign filenames to all tournaments
            tournaments.forEach((tournament, index) => {
                const filename = `tournament_${index + 1}.html`;
                tournament.filename = filename;
            });
            
            // Generate home page after filenames are assigned
            addLogEntry('Generating home page...');
            generatedPages['index.html'] = generateHomePage();
            updateProgress(60);
            
            // Generate individual tournament pages
            tournaments.forEach((tournament, index) => {
                addLogEntry(`Generating page for ${tournament.name}...`);
                
                if (tournament.type === 'team') {
                    generatedPages[tournament.filename] = generateTeamTournamentPage(tournament);
                } else {
                    generatedPages[tournament.filename] = generateIndividualTournamentPage(tournament);
                }
                
                progress += progressStep;
                updateProgress(Math.min(90, progress));
            });
            
            addLogEntry('All pages generated successfully!');
            updateProgress(100);
        }
        
        // Generate home page
        function generateHomePage() {
            const tournamentCards = tournaments.map((tournament, index) => {
                const playerCount = tournament.players.size;
                const gameCount = tournament.games.length;
                const teamCount = tournament.teams.size;
                
                return `
                    <div class="tournament-card">
                        <h3>${escapeHtml(tournament.name)}</h3>
                        <p class="tournament-date">${escapeHtml(tournament.date)}</p>
                        <p class="tournament-location">${escapeHtml(tournament.site)}</p>
                        <div class="tournament-stats">
                            ${tournament.type === 'team' ? 
                                `<span><i class="fas fa-users"></i> ${teamCount} teams</span>` :
                                `<span><i class="fas fa-user"></i> ${playerCount} players</span>`
                            }
                            <span><i class="fas fa-chess"></i> ${gameCount} games</span>
                        </div>
                        <a href="https://history.europechess.org/tournaments/${tournament.filename}" class="view-tournament-btn">View Tournament</a>
                    </div>
                `;
            }).join('');
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Tournaments</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #4a90e2, #81b6f5);
            color: white;
            text-align: center;
            padding: 60px 20px;
            margin-bottom: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .tournaments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }
        
        .tournament-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .tournament-card:hover {
            transform: translateY(-5px);
        }
        
        .tournament-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .tournament-date {
            color: #d4af37;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .tournament-location {
            color: #666;
            font-style: italic;
            margin-bottom: 20px;
        }
        
        .tournament-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .tournament-stats span {
            color: #555;
        }
        
        .tournament-stats i {
            color: #4a90e2;
            margin-right: 5px;
        }
        
        .view-tournament-btn {
            display: block;
            background: linear-gradient(135deg, #4a90e2, #81b6f5);
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .view-tournament-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stats-summary {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4a90e2;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Chess Tournament Collection</h1>
            <p>Browse all tournaments from the PGN file</p>
        </div>
        
        <div class="stats-summary">
            <h2>Overview</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">${tournaments.length}</div>
                    <div class="stat-label">Tournaments</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${tournaments.reduce((sum, t) => sum + t.games.length, 0)}</div>
                    <div class="stat-label">Total Games</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${new Set(tournaments.flatMap(t => Array.from(t.players))).size}</div>
                    <div class="stat-label">Unique Players</div>
                </div>
            </div>
        </div>
        
        <h2 style="color: #2c3e50; text-align: center;">All Tournaments</h2>
        
        <div class="tournaments-grid">
            ${tournamentCards}
        </div>
    </div>
</body>
</html>`;
        }
        
        // Generate individual tournament page
        function generateIndividualTournamentPage(tournament) {
            // Calculate standings
            const standings = calculateIndividualStandings(tournament);
            
            // Get top 3 for podium
            const podium = standings.slice(0, 3);
            const medal = ['ü•á', 'ü•à', 'ü•â'];
            
            // Calculate statistics
            const whiteWins = tournament.games.filter(g => g.result === '1-0').length;
            const blackWins = tournament.games.filter(g => g.result === '0-1').length;
            const draws = tournament.games.filter(g => g.result === '1/2-1/2').length;
            const totalGames = tournament.games.length;
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(tournament.name)}</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #4a90e2, #81b6f5);
            color: white;
            text-align: center;
            padding: 60px 20px;
            margin-bottom: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .navigation {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .nav-button {
            background: white;
            color: #4a90e2;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin: 0 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .podium {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .podium h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 40px;
            font-size: 2.5rem;
        }
        
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: end;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .podium-place {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            min-width: 200px;
            transition: transform 0.3s ease;
        }
        
        .podium-place:hover {
            transform: translateY(-5px);
        }
        
        .podium-place.first {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            order: 2;
            transform: scale(1.1);
        }
        
        .podium-place.second {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            order: 1;
        }
        
        .podium-place.third {
            background: linear-gradient(135deg, #cd7f32, #daa520);
            order: 3;
        }
        
        .medal {
            font-size: 4rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .podium-place h3 {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            color: #2c3e50;
        }
        
        .podium-place .score {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #2c3e50;
            border-bottom: 3px solid #4a90e2;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .standings {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background: linear-gradient(135deg, #4a90e2, #81b6f5);
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
        }
        
        .medal-winner {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
            font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="navigation">
            <a href="https://history.europechess.org/tournaments/index.html" class="nav-button">
                <i class="fas fa-home"></i> Back to Tournaments
            </a>
        </div>
        
        <div class="header">
            <h1>${escapeHtml(tournament.name)}</h1>
            <div class="subtitle">${escapeHtml(tournament.site)} ‚Ä¢ ${escapeHtml(tournament.date)}</div>
        </div>
        
        ${podium.length > 0 ? `
        <div class="podium">
            <h2>üèÜ Winners</h2>
            <div class="podium-container">
                ${podium.map((player, index) => `
                    <div class="podium-place ${index === 0 ? 'first' : index === 1 ? 'second' : 'third'}">
                        <span class="medal">${medal[index]}</span>
                        <h3>${escapeHtml(player.name)}</h3>
                        <div class="score">${player.score} pts</div>
                        <div>${player.games} games</div>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Tournament Overview</h3>
                <div class="stat-item">
                    <span>Total Players</span>
                    <strong>${tournament.players.size}</strong>
                </div>
                <div class="stat-item">
                    <span>Games Played</span>
                    <strong>${totalGames}</strong>
                </div>
                <div class="stat-item">
                    <span>Rounds</span>
                    <strong>${tournament.rounds.size || 'N/A'}</strong>
                </div>
            </div>
            
            <div class="stat-card">
                <h3>Game Results</h3>
                <div class="stat-item">
                    <span>White Wins</span>
                    <strong>${whiteWins} (${Math.round((whiteWins / totalGames) * 100)}%)</strong>
                </div>
                <div class="stat-item">
                    <span>Black Wins</span>
                    <strong>${blackWins} (${Math.round((blackWins / totalGames) * 100)}%)</strong>
                </div>
                <div class="stat-item">
                    <span>Draws</span>
                    <strong>${draws} (${Math.round((draws / totalGames) * 100)}%)</strong>
                </div>
            </div>
        </div>
        
        <div class="standings">
            <h3>Final Standings</h3>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Score</th>
                        <th>Games</th>
                        <th>W-D-L</th>
                        ${standings.some(p => p.elo) ? '<th>Rating</th>' : ''}
                    </tr>
                </thead>
                <tbody>
                    ${standings.map((player, index) => `
                        <tr class="${index < 3 ? 'medal-winner' : ''}">
                            <td>${index < 3 ? medal[index] : index + 1}</td>
                            <td>${escapeHtml(player.name)}</td>
                            <td><strong>${player.score}</strong></td>
                            <td>${player.games}</td>
                            <td>${player.wins}-${player.draws}-${player.losses}</td>
                            ${standings.some(p => p.elo) ? `<td>${player.elo || '-'}</td>` : ''}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>`;
        }
        
        // Generate team tournament page
        function generateTeamTournamentPage(tournament) {
            // Calculate team standings
            const teamStandings = calculateTeamStandings(tournament);
            
            // Get top 3 teams
            const podium = teamStandings.slice(0, 3);
            const medal = ['ü•á', 'ü•à', 'ü•â'];
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(tournament.name)}</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #4a90e2, #81b6f5);
            color: white;
            text-align: center;
            padding: 60px 20px;
            margin-bottom: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .navigation {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .nav-button {
            background: white;
            color: #4a90e2;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin: 0 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .team-badge {
            background: #4a90e2;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .podium {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .podium h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 40px;
            font-size: 2.5rem;
        }
        
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: end;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .podium-place {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            min-width: 220px;
            transition: transform 0.3s ease;
        }
        
        .podium-place:hover {
            transform: translateY(-5px);
        }
        
        .podium-place.first {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            order: 2;
            transform: scale(1.1);
        }
        
        .podium-place.second {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            order: 1;
        }
        
        .podium-place.third {
            background: linear-gradient(135deg, #cd7f32, #daa520);
            order: 3;
        }
        
        .medal {
            font-size: 4rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .standings {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background: linear-gradient(135deg, #4a90e2, #81b6f5);
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
        }
        
        .medal-winner {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
            font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="navigation">
            <a href="https://history.europechess.org/tournaments/index.html" class="nav-button">
                <i class="fas fa-home"></i> Back to Tournaments
            </a>
        </div>
        
        <div class="header">
            <div class="team-badge">TEAM TOURNAMENT</div>
            <h1>${escapeHtml(tournament.name)}</h1>
            <div class="subtitle">${escapeHtml(tournament.site)} ‚Ä¢ ${escapeHtml(tournament.date)}</div>
        </div>
        
        ${podium.length > 0 ? `
        <div class="podium">
            <h2>üèÜ Winning Teams</h2>
            <div class="podium-container">
                ${podium.map((team, index) => `
                    <div class="podium-place ${index === 0 ? 'first' : index === 1 ? 'second' : 'third'}">
                        <span class="medal">${medal[index]}</span>
                        <h3>${escapeHtml(team.name)}</h3>
                        <div class="score" style="font-size: 2rem; font-weight: bold; color: #2c3e50; margin: 10px 0;">
                            ${team.matchPoints} MP
                        </div>
                        <div style="color: #666;">
                            ${team.gamePoints} game points
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        <div class="standings">
            <h3>Team Standings</h3>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Team</th>
                        <th>Match Points</th>
                        <th>Game Points</th>
                        <th>Matches</th>
                        <th>W-D-L</th>
                    </tr>
                </thead>
                <tbody>
                    ${teamStandings.map((team, index) => `
                        <tr class="${index < 3 ? 'medal-winner' : ''}">
                            <td>${index < 3 ? medal[index] : index + 1}</td>
                            <td>${escapeHtml(team.name)}</td>
                            <td><strong>${team.matchPoints}</strong></td>
                            <td>${team.gamePoints}</td>
                            <td>${team.matches}</td>
                            <td>${team.wins}-${team.draws}-${team.losses}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>`;
        }
        
        // Calculate individual standings
        function calculateIndividualStandings(tournament) {
            const playerStats = {};
            
            // Initialize player stats
            tournament.players.forEach(player => {
                const details = tournament.playerDetails[player] || {};
                playerStats[player] = {
                    name: player,
                    elo: details.elo || '',
                    games: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    score: 0
                };
            });
            
            // Calculate scores from games
            tournament.games.forEach(game => {
                const white = game.white;
                const black = game.black;
                
                if (playerStats[white]) playerStats[white].games++;
                if (playerStats[black]) playerStats[black].games++;
                
                if (game.result === '1-0') {
                    if (playerStats[white]) {
                        playerStats[white].wins++;
                        playerStats[white].score += 1;
                    }
                    if (playerStats[black]) {
                        playerStats[black].losses++;
                    }
                } else if (game.result === '0-1') {
                    if (playerStats[black]) {
                        playerStats[black].wins++;
                        playerStats[black].score += 1;
                    }
                    if (playerStats[white]) {
                        playerStats[white].losses++;
                    }
                } else if (game.result === '1/2-1/2') {
                    if (playerStats[white]) {
                        playerStats[white].draws++;
                        playerStats[white].score += 0.5;
                    }
                    if (playerStats[black]) {
                        playerStats[black].draws++;
                        playerStats[black].score += 0.5;
                    }
                }
            });
            
            // Sort by score
            return Object.values(playerStats).sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                if (b.wins !== a.wins) return b.wins - a.wins;
                return a.name.localeCompare(b.name);
            });
        }
        
        // Calculate team standings
        function calculateTeamStandings(tournament) {
            const teamStats = {};
            
            // Initialize team stats
            tournament.teams.forEach(team => {
                teamStats[team] = {
                    name: team,
                    matchPoints: 0,
                    gamePoints: 0,
                    matches: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    matchResults: {}
                };
            });
            
            // Group games by round to determine match results
            const roundGames = {};
            tournament.games.forEach(game => {
                const round = game.round || 'Unknown';
                if (!roundGames[round]) roundGames[round] = [];
                roundGames[round].push(game);
            });
            
            // Calculate match results for each round
            Object.values(roundGames).forEach(games => {
                const matchScores = {};
                
                games.forEach(game => {
                    const whiteTeam = game.whiteTeam;
                    const blackTeam = game.blackTeam;
                    
                    if (!whiteTeam || !blackTeam) return;
                    
                    const matchKey = `${whiteTeam} vs ${blackTeam}`;
                    if (!matchScores[matchKey]) {
                        matchScores[matchKey] = {
                            team1: whiteTeam,
                            team2: blackTeam,
                            score1: 0,
                            score2: 0
                        };
                    }
                    
                    if (game.result === '1-0') {
                        matchScores[matchKey].score1 += 1;
                    } else if (game.result === '0-1') {
                        matchScores[matchKey].score2 += 1;
                    } else if (game.result === '1/2-1/2') {
                        matchScores[matchKey].score1 += 0.5;
                        matchScores[matchKey].score2 += 0.5;
                    }
                });
                
                // Award match points
                Object.values(matchScores).forEach(match => {
                    if (teamStats[match.team1]) {
                        teamStats[match.team1].gamePoints += match.score1;
                        teamStats[match.team1].matches++;
                        
                        if (match.score1 > match.score2) {
                            teamStats[match.team1].matchPoints += 2;
                            teamStats[match.team1].wins++;
                        } else if (match.score1 === match.score2) {
                            teamStats[match.team1].matchPoints += 1;
                            teamStats[match.team1].draws++;
                        } else {
                            teamStats[match.team1].losses++;
                        }
                    }
                    
                    if (teamStats[match.team2]) {
                        teamStats[match.team2].gamePoints += match.score2;
                        teamStats[match.team2].matches++;
                        
                        if (match.score2 > match.score1) {
                            teamStats[match.team2].matchPoints += 2;
                            teamStats[match.team2].wins++;
                        } else if (match.score2 === match.score1) {
                            teamStats[match.team2].matchPoints += 1;
                            teamStats[match.team2].draws++;
                        } else {
                            teamStats[match.team2].losses++;
                        }
                    }
                });
            });
            
            // Sort by match points, then game points
            return Object.values(teamStats).sort((a, b) => {
                if (b.matchPoints !== a.matchPoints) return b.matchPoints - a.matchPoints;
                if (b.gamePoints !== a.gamePoints) return b.gamePoints - a.gamePoints;
                return a.name.localeCompare(b.name);
            });
        }
        
        // Show results
        function showResults() {
            // Hide other sections and show results
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('errorSection').style.display = 'none';
            
            // Show tournament cards
            const tournamentGrid = document.getElementById('tournamentGrid');
            tournamentGrid.innerHTML = '';
            
            tournaments.forEach(tournament => {
                const card = document.createElement('div');
                card.className = 'tournament-card';
                
                const playerCount = tournament.players.size;
                const gameCount = tournament.games.length;
                const teamCount = tournament.teams.size;
                
                card.innerHTML = `
                    <div class="tournament-name">${escapeHtml(tournament.name)}</div>
                    <div class="tournament-info">üìç ${escapeHtml(tournament.site)}</div>
                    <div class="tournament-info">üìÖ ${escapeHtml(tournament.date)}</div>
                    <div class="tournament-info">üéÆ ${gameCount} games</div>
                    <div class="tournament-info">
                        ${tournament.type === 'team' ? 
                            `üë• ${teamCount} teams` :
                            `üë§ ${playerCount} players`
                        }
                    </div>
                    <div class="tournament-type">${tournament.type}</div>
                `;
                
                tournamentGrid.appendChild(card);
            });
            
            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        // Auto-save pages after processing
        async function autoSavePages() {
            try {
                // Prepare tournament info
                const tournamentInfo = tournaments.map(t => ({
                    name: t.name,
                    type: t.type,
                    site: t.site,
                    date: t.date,
                    players: t.players.size,
                    teams: t.teams.size,
                    games: t.games.length,
                    filename: t.filename
                }));
                
                // Send pages to server
                const response = await fetch('/api/save-pages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pages: generatedPages,
                        info: tournamentInfo
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLogEntry(`‚úì Saved ${result.files.length} pages to server`);
                    addLogEntry(`‚úì Website published at: https://history.europechess.org/tournaments/`);
                } else {
                    throw new Error(result.error || 'Failed to save pages');
                }
                
                return result;
            } catch (error) {
                console.error('Error saving pages:', error);
                addLogEntry(`‚úó Error saving to server: ${error.message}`, true);
                throw error;
            }
        }
        
        // Save all pages to the server
        async function downloadAllPages() {
            try {
                // Show saving status
                const btn = document.getElementById('downloadAllBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing Website...';
                btn.disabled = true;
                
                // Prepare tournament info
                const tournamentInfo = tournaments.map(t => ({
                    name: t.name,
                    type: t.type,
                    site: t.site,
                    date: t.date,
                    players: t.players.size,
                    teams: t.teams.size,
                    games: t.games.length,
                    filename: t.filename
                }));
                
                // Send pages to server
                const response = await fetch('/api/save-pages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pages: generatedPages,
                        info: tournamentInfo
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update button to show success
                    btn.innerHTML = '<i class="fas fa-check"></i> Website Published!';
                    btn.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                    
                    // Show success message with link
                    const downloadInfo = document.querySelector('.download-info');
                    downloadInfo.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <strong style="color: #155724;">‚úì Website successfully published!</strong><br>
                            <a href="${result.index_url}" target="_blank" style="color: #155724; text-decoration: underline;">
                                View your tournament website ‚Üí
                            </a>
                        </div>
                    `;
                    
                    // Reset button after delay
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        btn.style.background = '';
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Failed to save pages');
                }
            } catch (error) {
                console.error('Error saving pages:', error);
                alert('Error publishing website: ' + error.message);
                
                // Reset button
                const btn = document.getElementById('downloadAllBtn');
                btn.innerHTML = '<i class="fas fa-download"></i> Publish Website';
                btn.disabled = false;
            }
        }
        
        // Preview home page
        function previewHomePage() {
            const content = generatedPages['index.html'];
            const blob = new Blob([content], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }
        
        // Reset processor
        function resetProcessor() {
            // Clear data
            pgnContent = '';
            tournaments = [];
            generatedPages = {};
            
            // Reset UI
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('processingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            
            // Clear file input
            document.getElementById('fileInput').value = '';
        }
        
        // Show error
        function showError(message, details = '') {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDetails').textContent = details;
        }
        
        // Update progress
        function updateProgress(percent, message) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = Math.round(percent) + '%';
            
            // Optionally add log message if provided
            if (message) {
                addLogEntry(message);
            }
        }
        
        // Add log entry
        function addLogEntry(message, isError = false) {
            const log = document.getElementById('processingLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry' + (isError ? ' error' : '');
            entry.textContent = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        // Clear log
        function clearLog() {
            document.getElementById('processingLog').innerHTML = '';
        }
        
        // Escape HTML
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str || '';
            return div.innerHTML;
        }
    </script>
</body>
</html>